# 性能对比

## 测试平台

测试用的是工作机，配置如下：

硬件

```
处理器：Intel(R) Core(TM) i5-10500 CPU @ 3.10GHz   3.10 GHz
内存: 16.0 GB (15.7 GB 可用)
```

软件

```
Windows 10 专业版 装有沙盒
```

## 测试环境

莫章永的宏程序版本简称莫版宏程序。

莫版宏程序是基于GTest测试的。此版本的词法语法与Worker紧密绑定，无法轻易剥离，因此测试时挂靠在流水线上运行。运行时只有一个GParser和一个后端，基本上没什么负载。文件读取使用的是文件内存映射。

新版本的宏程序则基于单元测试。此版本与Worker完全独立，可独自测试，其负载为零。文件读取使用的是C语言的fopen接口。

两者的运行条件不完全对等，莫版的负载（与解析无关的部分）略高于新版，但是使用内存映射，在文件读取上占有优势。

所以，基于上述测试环境得出的数据，还是具有一定参考性的。

## 测试性能

### 测试用例1——《兰亭集序》

执行一次《兰亭集序》解析，数据对比如下：

莫版

```
10.9429 MB		-- 总大小
1.45334 s		-- 总耗时
7.52946 MB/s	-- 平均速率
```


新版

```
10.9429 MB
1.46633 s
7.46276 MB/s
```

结论：可以看出，在纯G代码的情况下，两者解析速率相当。

### 测试用例2——宏程序

文件内容如下：

```
#1 = 1
#2 = 20
IF NOT [#1 GE #2] THEN
	#3 = 3
	
	WHILE [#1 LT #2] DO
		#1 = #1 +1
		#3 = #3 + 1
		IF #1 LT #3 THEN
			#10 = 234.5
			#20 = MAX[#MIN[1,2,3], 3.5, 10]
			WHILE [#20 LT 25] DO
				#20 = 1 + #20
			END
			#100 = 100
			IF #20 EQ 25 THEN
				#[#20 ]= #100
			ENDIF
		ENDIF

		G1 X#3
	END
	#5=5
ELSE
	#4 = 4
ENDIF
```

上述文件执行100次的结果如下：

莫版


```
0.0348 MB	-- 总大小为上述文件的100倍大小
7.13394 s
0.00487809 MB/s
```

新版

```
0.0348 MB
0.136455 s
0.255029 MB/s
```

结论：如果是复杂的宏程序语法，那么新版比莫版快50倍以上。

(测试用例待补充)

## 分析总结

1. 如果文件中没有宏程序，莫版几乎等同于以前的GParser。以前的GParser有个特点，就是几乎只需要词法分析就可以完成解析，语法分析部分非常弱，因此性能方面可以保持较高水准。但是一旦进入宏程序解析，那就要进入新增的语法分析代码，这部分代码，莫版使用了大量RTTI、list遍历、shared_ptr等耗时操作，而且还有同样代码反复执行的问题（例如WHILE循环100次，那么词法语法将重复100次），因此性能较差。
2. 新版的性能瓶颈在于，生成语法树的过程中产生大量堆内存分配，这部分除了树的各个节点本身以外还包括计算过程中各容器的分配。但是这部分耗时操作通过使用C++17提供的pmr，也就是动态内存资源（相当于内存池），已经得到解决了。另外，新版全程使用unique_ptr进行内存管理，unique_ptr相对shared_ptr来说，它是所有权独享的，因此它不像shared_ptr那样持有原子变量来记录引用计数，其性能比shared_ptr好得多，也更加安全。所以，新版在性能上较优是在预期之中的。